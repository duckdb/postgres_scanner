#!/bin/sh
rm -rf postgres
mkdir postgres
curl -s -L https://github.com/postgres/postgres/archive/refs/tags/REL_14_2.tar.gz | tar xz --strip-components 1 -C postgres

if [ "$CC" = "aarch64-linux-gnu-gcc" ]; then
    CROSS_COMPILE_FLAG="--host=aarch64-linux-gnu"
else
    CROSS_COMPILE_FLAG=""
fi

if [ "$OS" = "Windows_NT" ]; then
  (cd postgres/src/tools/msvc/ && perl mkvcbuild.pl)
else
  (cd postgres && ./configure \
    --without-llvm        \
    --without-icu         \
    --without-tcl         \
    --without-perl        \
    --without-python      \
    --without-gssapi      \
    --without-pam         \
    --without-bsd-auth    \
    --without-ldap        \
    --without-bonjour     \
    --without-selinux     \
    --without-systemd     \
    --without-readline    \
    --without-libxml      \
    --without-libxslt     \
    --without-zlib        \
    --without-lz4         \
    $CROSS_COMPILE_FLAG   \
    --without-openssl  > /dev/null)
fi
